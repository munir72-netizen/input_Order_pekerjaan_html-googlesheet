<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Tabel dari Google Sheet</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <!-- SweetAlert2 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css"
    />
  </head>
  <body class="bg-light">
    <div class="container-fluid bg-white">
      <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-3">
        <div class="container">
          <a class="navbar-brand fw-bold text-primary" href="#"
            >Order Pekerjaan</a
          >
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link active" href="index.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="tabel.html">Tabel</a>
              </li>
              <li class="nav-item"><a class="nav-link" href="#">Pricing</a></li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="navbarDropdownMenuLink"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Lainnya
                </a>
                <ul
                  class="dropdown-menu"
                  aria-labelledby="navbarDropdownMenuLink"
                >
                  <li><a class="dropdown-item" href="#">Action</a></li>
                  <li><a class="dropdown-item" href="#">Another action</a></li>
                  <li>
                    <a class="dropdown-item" href="#">Something else here</a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </div>

    <div class="container py-4">
      <a href="input.html">
        <button class="btn btn-primary mb-3">Input Data</button>
      </a>
      <h3 class="mb-4">Tabel dari Google Sheet</h3>

      <!-- Loader -->
      <div id="loader" class="text-center my-5">
        <div
          class="spinner-border text-primary"
          role="status"
          style="width: 3rem; height: 3rem"
        >
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2">Memuat data...</div>
      </div>

      <!-- Container tabel -->
      <div class="table-responsive" style="display: none" id="tableContainer">
        <table
          id="sheetTable"
          class="table table-striped table-bordered"
          style="width: 100%"
        ></table>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>

    <script>
      const scriptUrl =
        "https://script.google.com/macros/s/AKfycbyRSK82g1PNKhXcwxkctOS5SmeaVM5bzLvP7QMKlxrUS8bquGrXnTNe2nfc3PzEg5kJ/exec";

      function formatDate(dateStr) {
        if (!dateStr) return "";
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;
        return d.toISOString().slice(0, 10);
      }

      function statusBadge(status) {
        if (status === "Selesai") {
          return '<span class="badge bg-success">Selesai</span>';
        } else if (status === "Proses") {
          return '<span class="badge bg-warning text-dark">Proses</span>';
        } else if (status === "Pending") {
          return '<span class="badge bg-danger">Pending</span>';
        } else {
          return `<span class="badge bg-secondary">${status}</span>`;
        }
      }

      function showLoader(show) {
        document.getElementById("loader").style.display = show
          ? "block"
          : "none";
        document.getElementById("tableContainer").style.display = show
          ? "none"
          : "block";
      }

      function loadTable() {
        showLoader(true);
        fetch(scriptUrl)
          .then((response) => response.json())
          .then((data) => {
            const header = data[0];
            const rows = data.slice(1);

            let thead = "<thead><tr>";
            header.forEach((col) => {
              thead += `<th>${col}</th>`;
            });
            thead += "<th>Action</th></tr></thead>";

            let tbody = "<tbody>";
            rows.forEach((row, i) => {
              tbody += "<tr>";
              row.forEach((cell, idx) => {
                if (header[idx] === "tanggal_order") {
                  cell = formatDate(cell);
                }
                if (header[idx] === "proses") {
                  cell = statusBadge(cell);
                }
                tbody += `<td>${cell}</td>`;
              });
              tbody += `<td>
                <button class="btn btn-sm btn-info me-2" onclick="editStatus(${
                  i + 2
                }, '${row[4]}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteRow(${
                  i + 2
                })">Delete</button>
              </td>`;
              tbody += "</tr>";
            });
            tbody += "</tbody>";

            document.getElementById("sheetTable").innerHTML = thead + tbody;

            $("#sheetTable").DataTable({
              responsive: true,
              destroy: true,
            });

            showLoader(false);
          })
          .catch(() => {
            showLoader(false);
            Swal.fire("Gagal!", "Tidak bisa memuat data.", "error");
          });
      }

      // Fungsi Edit Status
      window.editStatus = function (rowIndex, currentStatus) {
        Swal.fire({
          title: "Update Status",
          input: "select",
          inputOptions: {
            Proses: "Proses",
            Selesai: "Selesai",
            Pending: "Pending",
          },
          inputValue: currentStatus,
          showCancelButton: true,
          confirmButtonText: "Update",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(scriptUrl, {
              method: "POST",
              body: new URLSearchParams({
                action: "updateStatus",
                rowIndex: rowIndex,
                status: result.value,
              }),
            })
              .then((r) => r.json())
              .then((res) => {
                if (res.status === "success") {
                  Swal.fire("Berhasil!", res.message, "success");
                  loadTable();
                } else {
                  Swal.fire("Error!", res.message, "error");
                }
              })
              .catch(() =>
                Swal.fire("Error!", "Gagal mengirim data.", "error")
              );
          }
        });
      };

      // Fungsi Delete Row
      window.deleteRow = function (rowIndex) {
        Swal.fire({
          title: "Yakin hapus data?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, hapus",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(scriptUrl, {
              method: "POST",
              body: new URLSearchParams({
                action: "delete",
                rowIndex: rowIndex,
              }),
            })
              .then((r) => r.json())
              .then((res) => {
                if (res.status === "success") {
                  Swal.fire("Terhapus!", res.message, "success");
                  loadTable();
                } else {
                  Swal.fire("Error!", res.message, "error");
                }
              })
              .catch(() =>
                Swal.fire("Error!", "Gagal menghapus data.", "error")
              );
          }
        });
      };

      // Panggil pertama kali
      loadTable();
    </script>
  </body>
</html>
